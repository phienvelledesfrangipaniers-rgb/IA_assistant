<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assistant IA Pharmacie</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      }
      body {
        margin: 0;
        background: #f5f7fb;
        color: #1f2937;
      }
      header {
        background: #111827;
        color: #fff;
        padding: 24px 32px;
      }
      header h1 {
        margin: 0 0 6px 0;
        font-size: 22px;
      }
      header p {
        margin: 0;
        opacity: 0.8;
      }
      main {
        max-width: 1100px;
        margin: 24px auto;
        padding: 0 24px 48px;
        display: grid;
        gap: 20px;
      }
      section {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
      }
      section h2 {
        margin: 0 0 12px 0;
        font-size: 18px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 12px;
      }
      label {
        display: block;
        font-size: 13px;
        margin-bottom: 6px;
        color: #4b5563;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        font-size: 14px;
      }
      button {
        background: #2563eb;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 10px 14px;
        font-weight: 600;
        cursor: pointer;
      }
      button.secondary {
        background: #e5e7eb;
        color: #111827;
      }
      pre {
        background: #0f172a;
        color: #e2e8f0;
        padding: 12px;
        border-radius: 8px;
        overflow-x: auto;
        font-size: 12px;
      }
      .status {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .pill {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
      }
      .pill.ok {
        background: #dcfce7;
        color: #166534;
      }
      .pill.warn {
        background: #fef9c3;
        color: #854d0e;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Assistant IA Pharmacie</h1>
      <p>Console de pilotage pour extraction Winpharma, KPI et RAG.</p>
    </header>
    <main>
      <section>
        <h2>État de l'API</h2>
        <div class="status">
          <button id="health-btn">Tester /health</button>
          <span id="health-status" class="pill warn">Non testé</span>
        </div>
        <pre id="health-output">Cliquez sur "Tester /health" pour vérifier la connexion.</pre>
      </section>

      <section>
        <h2>Extraction Winpharma</h2>
        <div class="grid">
          <div>
            <label for="extract-pharma">Pharmacie</label>
            <input id="extract-pharma" placeholder="frang" value="frang" />
          </div>
          <div>
            <label for="extract-dataset">Dataset</label>
            <select id="extract-dataset">
              <option value="sales">sales</option>
              <option value="products">products</option>
              <option value="stock">stock</option>
              <option value="purchases">purchases</option>
            </select>
          </div>
        </div>
        <div style="margin-top: 12px">
          <button id="extract-btn">Lancer l'extraction</button>
        </div>
        <pre id="extract-output">Aucune extraction lancée.</pre>
      </section>

      <section>
        <h2>KPI</h2>
        <div class="grid">
          <div>
            <label for="kpi-pharma">Pharmacie</label>
            <input id="kpi-pharma" placeholder="frang" value="frang" />
          </div>
          <div>
            <label for="kpi-from">Du</label>
            <input id="kpi-from" type="date" />
          </div>
          <div>
            <label for="kpi-to">Au</label>
            <input id="kpi-to" type="date" />
          </div>
        </div>
        <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap">
          <button class="secondary" data-kpi="sales">Ventes</button>
          <button class="secondary" data-kpi="stock_alerts">Alertes stock</button>
          <button class="secondary" data-kpi="purchases">Achats</button>
        </div>
        <pre id="kpi-output">Sélectionnez un KPI.</pre>
      </section>

      <section>
        <h2>RAG (documents internes)</h2>
        <div class="grid">
          <div>
            <label for="rag-pharma">Pharmacie</label>
            <input id="rag-pharma" placeholder="frang" value="frang" />
          </div>
          <div>
            <label for="rag-path">Dossier à indexer</label>
            <input id="rag-path" placeholder="/data/docs" />
          </div>
        </div>
        <div style="margin-top: 12px">
          <button id="rag-index-btn">Indexer</button>
        </div>
        <div style="margin-top: 16px">
          <label for="rag-files">Uploader des documents (PDF, DOCX, TXT)</label>
          <input id="rag-files" type="file" multiple />
          <button id="rag-upload-btn" style="margin-top: 8px">Uploader et indexer</button>
        </div>
        <div style="margin-top: 12px">
          <label for="rag-question">Question</label>
          <textarea id="rag-question" rows="3" placeholder="Quels sont les top ventes ?"></textarea>
          <button id="rag-ask-btn" style="margin-top: 8px">Poser la question</button>
        </div>
        <pre id="rag-output">Indexez des documents ou posez une question.</pre>
      </section>
    </main>
    <script>
      const healthBtn = document.getElementById("health-btn");
      const healthOutput = document.getElementById("health-output");
      const healthStatus = document.getElementById("health-status");

      healthBtn.addEventListener("click", async () => {
        healthOutput.textContent = "Chargement...";
        const response = await fetch("/health");
        const data = await response.json();
        healthOutput.textContent = JSON.stringify(data, null, 2);
        healthStatus.textContent = data.database ? "OK" : "DB KO";
        healthStatus.className = `pill ${data.database ? "ok" : "warn"}`;
      });

      document.getElementById("extract-btn").addEventListener("click", async () => {
        const pharma = document.getElementById("extract-pharma").value;
        const dataset = document.getElementById("extract-dataset").value;
        const output = document.getElementById("extract-output");
        output.textContent = "Extraction en cours...";
        const response = await fetch(`/extract/${pharma}/${dataset}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ params: null }),
        });
        const data = await response.json();
        output.textContent = JSON.stringify(data, null, 2);
      });

      document.querySelectorAll("button[data-kpi]").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const pharma = document.getElementById("kpi-pharma").value;
          const from = document.getElementById("kpi-from").value;
          const to = document.getElementById("kpi-to").value;
          const endpoint = btn.dataset.kpi;
          const params = new URLSearchParams();
          if (from) params.append("from", from);
          if (to) params.append("to", to);
          const response = await fetch(`/kpi/${pharma}/${endpoint}?${params.toString()}`);
          const data = await response.json();
          document.getElementById("kpi-output").textContent = JSON.stringify(data, null, 2);
        });
      });

      document.getElementById("rag-index-btn").addEventListener("click", async () => {
        const pharma = document.getElementById("rag-pharma").value;
        const path = document.getElementById("rag-path").value;
        const output = document.getElementById("rag-output");
        output.textContent = "Indexation en cours...";
        const response = await fetch("/rag/index", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ pharma_id: pharma, path }),
        });
        const data = await response.json();
        output.textContent = JSON.stringify(data, null, 2);
      });

      document.getElementById("rag-ask-btn").addEventListener("click", async () => {
        const pharma = document.getElementById("rag-pharma").value;
        const question = document.getElementById("rag-question").value;
        const output = document.getElementById("rag-output");
        output.textContent = "Analyse en cours...";
        const response = await fetch("/rag/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ pharma_id: pharma, question }),
        });
        const data = await response.json();
        output.textContent = JSON.stringify(data, null, 2);
      });

      document.getElementById("rag-upload-btn").addEventListener("click", async () => {
        const pharma = document.getElementById("rag-pharma").value;
        const files = document.getElementById("rag-files").files;
        const output = document.getElementById("rag-output");
        if (!files.length) {
          output.textContent = "Veuillez sélectionner au moins un fichier.";
          return;
        }
        output.textContent = "Upload en cours...";
        const formData = new FormData();
        formData.append("pharma_id", pharma);
        Array.from(files).forEach((file) => formData.append("files", file));
        const response = await fetch("/rag/upload", {
          method: "POST",
          body: formData,
        });
        const data = await response.json();
        output.textContent = JSON.stringify(data, null, 2);
      });
    </script>
  </body>
</html>
